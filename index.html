<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NeuralLift AI - Ultra Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #050505; color: #fff; font-family: -apple-system, system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.05); }
        .input-pro { background: #0a0a0a !important; border: 1px solid #1a1a1a !important; transition: all 0.3s ease; }
        .blue-glow { box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIEh7wcEQaAuXZbBmPHqqgdE2nplXOyPg",
            authDomain: "neurallift-ai.firebaseapp.com",
            projectId: "neurallift-ai",
            storageBucket: "neurallift-ai.firebasestorage.app",
            messagingSenderId: "446571622978",
            appId: "1:446571622978:web:7e2a2d01eb80f76db3b3db"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Exportamos las funciones necesarias para el login
        window.vault = { db, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, limit };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [userKey, setUserKey] = useState(localStorage.getItem("vault_token"));
            const [view, setView] = useState('routines');
            const [routines, setRoutines] = useState([]);
            const [logs, setLogs] = useState([]);
            const [isLoggingIn, setIsLoggingIn] = useState(false);

            useEffect(() => {
                if (!userKey) return;
                const { db, collection, onSnapshot, query, orderBy } = window.vault;
                
                const unsubR = onSnapshot(collection(db, `${userKey}_routines`), (snap) => {
                    setRoutines(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, (err) => {
                    // Si el token guardado ya no es válido según las reglas
                    console.error("Acceso denegado");
                    localStorage.removeItem("vault_token");
                    setUserKey(null);
                });
                
                const unsubL = onSnapshot(query(collection(db, `${userKey}_logs`), orderBy("timestamp", "desc")), (snap) => {
                    setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubR(); unsubL(); };
            }, [userKey]);

            const handleLogin = async (e) => {
                e.preventDefault();
                const pin = e.target.pin.value;
                if (!pin) return;

                setIsLoggingIn(true);
                try {
                    const { db, collection, getDocs, limit, query } = window.vault;
                    // VALIDACIÓN REAL: Intentamos leer la colección
                    // Si el PIN no cumple la regla de Firestore, esto lanzará un error
                    const q = query(collection(db, `${pin}_routines`), limit(1));
                    await getDocs(q); 
                    
                    // Si llegamos aquí, el PIN es válido para las reglas de Firebase
                    localStorage.setItem("vault_token", pin);
                    setUserKey(pin);
                } catch (error) {
                    alert("ACCESO DENEGADO: PIN incorrecto o sin permisos.");
                } finally {
                    setIsLoggingIn(false);
                }
            };

            if (!userKey) return (
                <div className="h-screen flex flex-col items-center justify-center p-8 bg-black">
                    <h1 className="text-5xl font-black italic mb-2 text-blue-600 tracking-tighter">NEURAL<span className="text-white">LIFT</span></h1>
                    <p className="text-zinc-600 text-[10px] uppercase tracking-[0.5em] mb-12">Security Layer Active</p>
                    <form onSubmit={handleLogin} className="w-full max-w-xs space-y-4">
                        <input name="pin" type="password" placeholder="INGRESA TU LLAVE" className="w-full p-6 rounded-3xl text-center text-xl outline-none glass border-white/10" />
                        <button disabled={isLoggingIn} className="w-full py-5 bg-blue-600 text-white rounded-3xl font-black uppercase text-xs tracking-[0.2em] blue-glow disabled:opacity-50">
                            {isLoggingIn ? "Verificando..." : "Autorizar Acceso"}
                        </button>
                    </form>
                </div>
            );

            // ... (Resto del código de la interfaz que ya tenías)
            return (
                <div className="max-w-md mx-auto p-6 pb-32 min-h-screen">
                    <header className="flex justify-between items-center mb-8 pt-4">
                        <h1 className="text-2xl font-black italic tracking-tighter uppercase">Neural<span className="text-blue-600">Lift</span></h1>
                        <button onClick={() => {localStorage.clear(); window.location.reload();}} className="text-[10px] text-zinc-500 font-bold">LOGOUT</button>
                    </header>

                    {view === 'routines' && (
                        <div className="space-y-6">
                            <button onClick={async () => {
                                const name = window.prompt("Nombre:");
                                if(name) await window.vault.addDoc(window.vault.collection(window.vault.db, `${userKey}_routines`), { name, exercises: [] });
                            }} className="w-full py-5 border border-dashed border-zinc-800 rounded-3xl text-zinc-600 text-[10px] font-black">+ Nueva Rutina</button>
                            
                            {routines.map(r => (
                                <div key={r.id} className="glass p-8 rounded-[2.5rem]">
                                    <h3 className="text-2xl font-black uppercase italic mb-4">{r.name}</h3>
                                    <button onClick={() => setView('workout')} className="w-full py-4 bg-blue-600 rounded-2xl font-black text-[11px] uppercase">Entrenar</button>
                                </div>
                            ))}
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 glass px-12 py-8 flex justify-around rounded-t-[3rem] z-40">
                        <button onClick={() => setView('routines')} className={view === 'routines' ? 'text-blue-500' : 'text-zinc-700'}>RUTINAS</button>
                        <button onClick={() => setView('history')} className={view === 'history' ? 'text-blue-500' : 'text-zinc-700'}>HISTORIAL</button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
